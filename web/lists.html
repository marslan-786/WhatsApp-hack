<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Impossible Bot App</title>
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --primary: #008069;
            --primary-dark: #005c4b;
            --bg-default: #111b21; /* Dark Mode Base */
            --bg-paper: #202c33;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --incoming-bubble: #202c33;
            --outgoing-bubble: #005c4b;
            --accent: #00a884;
        }
        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; 
            background-color: #0b141a; color: var(--text-primary); 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- 2. LOADING SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111b21; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .whatsapp-icon { width: 80px; height: 80px; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        .loading-bar { width: 150px; height: 4px; background: #202c33; border-radius: 2px; overflow: hidden; }
        .loading-progress { width: 0%; height: 100%; background: var(--accent); animation: load 2s ease-in-out forwards; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }

        /* --- 3. SESSION SELECTION (VIP CARDS) --- */
        #session-view {
            width: 100%; height: 100%; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
            background: radial-gradient(circle at top, #2a3942, #111b21);
        }
        .vip-header { font-size: 24px; font-weight: bold; margin-bottom: 30px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .sessions-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%; max-width: 800px; }
        
        .session-card {
            background: rgba(32, 44, 51, 0.8); backdrop-filter: blur(10px);
            width: 100%; max-width: 320px; padding: 20px; border-radius: 16px;
            border: 1px solid #2a3942; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
        }
        .session-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent);
        }
        .session-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 168, 132, 0.2); border-color: var(--accent); }
        .card-icon { font-size: 30px; background: #005c4b; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .card-info h3 { margin: 0; font-size: 18px; color: #fff; }
        .card-info p { margin: 5px 0 0; font-size: 13px; color: var(--text-secondary); }
        .status-dot { width: 10px; height: 10px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 5px #00ff00; margin-left: auto; }

        /* --- 4. APP INTERFACE (CONTAINER) --- */
        #app-interface { display: none; width: 100%; height: 100%; position: relative; overflow: hidden; }

        /* --- A. CHAT LIST PAGE --- */
        #chat-list-page {
            width: 100%; height: 100%; display: flex; flex-direction: column; background: #111b21;
            position: absolute; top: 0; left: 0; z-index: 10;
            transition: transform 0.3s ease-in-out;
        }
        
        /* App Header */
        .app-header {
            padding: 15px; background: #202c33; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .app-title { font-size: 20px; font-weight: bold; color: var(--text-secondary); }
        .exit-btn { background: none; border: none; color: #ef5350; font-weight: bold; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; background: #202c33; padding: 0 10px; }
        .tab {
            flex: 1; padding: 12px; text-align: center; color: var(--text-secondary); font-weight: 500; cursor: pointer;
            border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* List Items */
        .list-container { flex: 1; overflow-y: auto; }
        .chat-row {
            display: flex; padding: 12px 15px; align-items: center; cursor: pointer;
            border-bottom: 1px solid #222d34; transition: background 0.2s;
        }
        .chat-row:hover { background: #202c33; }
        .avatar { width: 45px; height: 45px; background: #6a7f8a; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; }
        .row-info { flex: 1; overflow: hidden; }
        .row-name { font-size: 16px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row-sub { font-size: 13px; color: var(--text-secondary); margin-top: 3px; }

        /* --- B. CONVERSATION PAGE (SLIDE IN) --- */
        #conversation-page {
            width: 100%; height: 100%; display: flex; flex-direction: column; background: #0b141a;
            position: absolute; top: 0; left: 0; z-index: 20;
            transform: translateX(100%); /* Hidden by default */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-header {
            height: 60px; background: #202c33; display: flex; align-items: center; padding: 0 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3); z-index: 5;
        }
        .back-btn { font-size: 24px; color: var(--text-primary); background: none; border: none; cursor: pointer; margin-right: 10px; }
        .header-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .header-title { font-size: 16px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-bg {
            flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat; opacity: 0.95; 
        }
        /* Message Bubbles */
        .msg { max-width: 75%; padding: 6px 10px; border-radius: 8px; font-size: 14.2px; position: relative; word-wrap: break-word; color: #fff; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg.sent { align-self: flex-end; background: var(--outgoing-bubble); border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: var(--incoming-bubble); border-top-left-radius: 0; }
        
        .sender-name { font-size: 12px; color: #aebac1; font-weight: bold; margin-bottom: 2px; display: block; }
        .msg-time { font-size: 10px; color: rgba(255,255,255,0.6); float: right; margin: 5px 0 0 8px; }

        /* Media */
        img.chat-media, video.chat-media { max-width: 100%; border-radius: 6px; margin-bottom: 2px; }
        .voice-note { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; gap: 8px; width: 220px; }
        audio { height: 30px; width: 100%; filter: invert(1); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

    </style>
</head>
<body>

    <div id="splash-screen">
        <svg class="whatsapp-icon" viewBox="0 0 33 33" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.6 0C7.4 0 0 7.4 0 16.5C0 20 1.1 23.3 3.1 26L1 33L8.2 30.8C10.7 32.2 13.6 33 16.6 33C25.7 33 33.1 25.6 33.1 16.5C33.1 7.4 25.7 0 16.6 0ZM16.6 27.7C14.1 27.7 11.8 27 9.8 25.8L9.3 25.5L4.8 26.9L6.2 22.6L5.8 22C4.5 19.9 3.8 17.5 3.8 15C3.8 7.9 9.6 2.2 16.6 2.2C23.6 2.2 29.4 7.9 29.4 15C29.4 22.1 23.6 27.7 16.6 27.7Z" fill="#00a884"/></svg>
        <div class="loading-bar"><div class="loading-progress"></div></div>
        <p style="margin-top:10px; color:#667781; font-size:12px;">End-to-end encrypted</p>
    </div>

    <div id="session-view" style="display:none;">
        <div class="vip-header">Select Session</div>
        <div class="sessions-grid" id="session-list-box">
            </div>
    </div>

    <div id="app-interface">
        
        <div id="chat-list-page">
            <div class="app-header">
                <span class="app-title">WhatsApp</span>
                <button class="exit-btn" onclick="location.reload()">LOGOUT</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chats')">Chats</div>
                <div class="tab" onclick="switchTab('groups')">Groups</div>
                <div class="tab" onclick="switchTab('channels')">Channels</div>
            </div>

            <div class="list-container" id="chat-list-box">
                <div style="text-align:center; padding:20px; color:var(--text-secondary);">Syncing...</div>
            </div>
        </div>

        <div id="conversation-page">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()">‚Üê</button>
                <div class="header-info">
                    <div class="avatar" style="width:35px; height:35px; font-size:14px;">üë§</div>
                    <div class="header-title" id="chat-header-name">User Name</div>
                </div>
            </div>
            
            <div class="chat-bg" id="messages-box">
                </div>
        </div>

    </div>

    <script>
        let currentBot = null;
        let allChatsCache = []; 
        let currentTab = 'chats';

        // --- SPLASH LOGIC ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                    document.getElementById('session-view').style.display = 'flex';
                    loadSessions();
                }, 500);
            }, 2000);
        };

        // --- 1. SESSIONS ---
        function loadSessions() {
            fetch('/api/sessions').then(res => res.json()).then(sessions => {
                const list = document.getElementById('session-list-box');
                list.innerHTML = '';
                
                sessions.forEach(num => {
                    let card = document.createElement('div');
                    card.className = 'session-card';
                    card.innerHTML = `
                        <div class="card-icon">üì±</div>
                        <div class="card-info">
                            <h3>${num}</h3>
                            <p>Connected ‚Ä¢ Ready</p>
                        </div>
                        <div class="status-dot"></div>
                    `;
                    card.onclick = () => openApp(num);
                    list.appendChild(card);
                });
            });
        }

        // --- 2. OPEN APP ---
        function openApp(botID) {
            currentBot = botID;
            document.getElementById('session-view').style.display = 'none';
            document.getElementById('app-interface').style.display = 'block';
            loadChats(botID);
        }

        // --- 3. CHAT LIST ---
        function loadChats(botID) {
            fetch(`/api/chats?bot_id=${botID}`).then(res => res.json()).then(chatIDs => {
                allChatsCache = chatIDs.map(id => ({
                    id: id,
                    isGroup: id.includes('@g.us'),
                    isChannel: id.includes('@newsletter'),
                    name: id.split('@')[0]
                }));
                renderChatList();
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            renderChatList();
        }

        function renderChatList() {
            const list = document.getElementById('chat-list-box');
            list.innerHTML = '';

            let filtered = allChatsCache.filter(c => {
                if(currentTab === 'groups') return c.isGroup;
                if(currentTab === 'channels') return c.isChannel;
                return !c.isGroup && !c.isChannel;
            });

            filtered.forEach(c => {
                let div = document.createElement('div');
                div.className = 'chat-row';
                div.innerHTML = `
                    <div class="avatar">üë§</div>
                    <div class="row-info">
                        <div class="row-name">${c.name}</div>
                        <div class="row-sub">${c.id}</div>
                    </div>
                `;
                div.onclick = () => openChat(c.id, c.name);
                list.appendChild(div);
            });
        }

        // --- 4. CONVERSATION VIEW (APP STYLE) ---
        function openChat(chatID, name) {
            document.getElementById('chat-header-name').innerText = name;
            const page = document.getElementById('conversation-page');
            const msgBox = document.getElementById('messages-box');
            
            msgBox.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Loading history...</div>';
            
            // Slide In Animation
            page.style.transform = 'translateX(0%)';

            fetch(`/api/messages?bot_id=${currentBot}&chat_id=${chatID}`)
                .then(res => res.json())
                .then(msgs => {
                    msgBox.innerHTML = '';
                    if(!msgs) return;

                    if(msgs.length > 0 && msgs[0].sender_name && msgs[0].sender_name !== chatID) {
                        document.getElementById('chat-header-name').innerText = msgs[0].sender_name;
                        let cached = allChatsCache.find(c => c.id === chatID);
                        if(cached) cached.name = msgs[0].sender_name;
                    }

                    msgs.forEach(m => {
                        let div = document.createElement('div');
                        div.className = 'msg ' + (m.is_from_me ? 'sent' : 'received');

                        let senderHtml = (!m.is_from_me && m.is_group) 
                            ? `<span class="sender-name">${m.sender_name || 'Unknown'}</span>` : '';

                        let contentHtml = '';
                        if(m.type === 'text') contentHtml = m.content;
                        else if (m.type === 'image') contentHtml = `<img src="${m.content}" class="chat-media" onclick="window.open(this.src)">`;
                        else if (m.type === 'video') contentHtml = `<video src="${m.content}" class="chat-media" controls></video>`;
                        else if (m.type === 'audio') contentHtml = `<div class="voice-note">üé§ <audio src="${m.content}" controls></audio></div>`;
                        else if (m.type === 'file') contentHtml = `<a href="${m.content}" target="_blank" style="color:white;">üìÑ File Attachment</a>`;

                        let time = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        div.innerHTML = `${senderHtml} ${contentHtml} <span class="msg-time">${time}</span>`;
                        msgBox.appendChild(div);
                    });
                    msgBox.scrollTop = msgBox.scrollHeight;
                });
        }

        function closeChat() {
            // Slide Out Animation
            document.getElementById('conversation-page').style.transform = 'translateX(100%)';
            // Refresh list (in case names updated)
            renderChatList();
        }

    </script>
</body>
</html>