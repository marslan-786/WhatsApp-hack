<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WhatsApp Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        :root {
            --bg-dark: #0f172a;
            --primary: #00a884;
            --bubble-sent: #005c4b;
            --bubble-rec: #202c33;
            --text-main: #e9edef;
            --text-muted: #8696a0;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0b141a; color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* UI Elements (Scrollbar etc) */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #374045; border-radius: 3px; }

        /* HOME & SESSION */
        #home-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .session-card { background: #202c33; width: 100%; max-width: 350px; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; cursor: pointer; border: 1px solid #374045; }

        /* APP VIEW */
        #app-view { display: none; width: 100%; height: 100%; position: relative; }
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; background: #111b21; }
        .app-header { height: 60px; background: #202c33; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .tabs { display: flex; background: #202c33; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-item { display: flex; padding: 12px 15px; align-items: center; gap: 15px; border-bottom: 1px solid #222d34; cursor: pointer; }
        .chat-item:hover { background: #202c33; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #6a7f8a; object-fit: cover; }

        /* CHAT WINDOW */
        #chat-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 50; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .chat-nav { height: 60px; background: #202c33; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .messages-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.95; padding-bottom: 80px; }

        /* MESSAGE BUBBLES */
        .msg { max-width: 80%; padding: 6px 8px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); color: #e9edef; line-height: 1.4; }
        .msg.sent { align-self: flex-end; background: var(--bubble-sent); border-top-right-radius: 0; }
        .msg.rec { align-self: flex-start; background: var(--bubble-rec); border-top-left-radius: 0; }
        .sender-name { font-size: 12px; color: #aebac1; font-weight: bold; display: block; margin-bottom: 4px; }
        .time { font-size: 10px; color: rgba(255,255,255,0.6); float: right; margin: 8px 0 0 8px; }

        /* --- üéµ WHATSAPP AUDIO PLAYER UI --- */
        .wa-audio-player {
            display: flex; align-items: center; gap: 12px; width: 260px; height: 50px;
            background: rgba(0,0,0,0.15); border-radius: 8px; padding: 0 10px; position: relative;
        }
        
        /* The Circle Button (Download / Play / Loading) */
        .control-btn {
            width: 40px; height: 40px; border-radius: 50%; background: #6a7f8a; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
        }
        .msg.sent .control-btn { background: #6a7f8a; } /* Consistent color */

        /* Icons */
        .icon { font-size: 20px; color: white; display: none; }
        .icon.show { display: block; }
        
        /* Spinner */
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); 
            border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        .spinner.show { display: block; }

        /* Audio Info */
        .audio-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .audio-meta { font-size: 11px; color: #8696a0; margin-top: 2px; }
        .progress-bar { width: 100%; height: 3px; background: rgba(255,255,255,0.3); margin-top: 5px; border-radius: 2px; position: relative; }
        .progress-fill { width: 0%; height: 100%; background: #fff; border-radius: 2px; }

        /* --- IMAGE DOWNLOADER --- */
        .img-blur-box {
            width: 240px; height: 240px; background: #2a3942; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .img-blur-box img.preview { width: 100%; height: 100%; object-fit: cover; opacity: 0.3; filter: blur(5px); }
        .dl-circle {
            position: absolute; width: 45px; height: 45px; background: rgba(0,0,0,0.4); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 2px solid #fff; color: #fff; font-weight: bold;
        }
        
        /* Lightbox */
        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 100; align-items: center; justify-content: center; }
        #lightbox img { max-width: 100%; max-height: 100%; }
        .lb-close { position: absolute; top: 20px; left: 20px; color: white; font-size: 30px; cursor: pointer; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="home-view">
        <h2 style="color:var(--primary);">ACTIVE SESSIONS</h2>
        <div id="session-list" style="width:100%;"></div>
    </div>

    <div id="app-view">
        <div class="sidebar">
            <div class="app-header">
                <span style="font-weight:bold; font-size:20px; color:#8696a0;">WhatsApp</span>
                <button onclick="location.reload()" style="background:none; border:none; color:#f15c6d;">LOGOUT</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chats')">Chats</button>
                <button class="tab-btn" onclick="switchTab('groups')">Groups</button>
                <button class="tab-btn" onclick="switchTab('channels')">Channels</button>
            </div>
            <div class="chat-list" id="chat-list-box"></div>
        </div>

        <div id="chat-window">
            <div class="chat-nav">
                <button onclick="document.getElementById('chat-window').style.transform='translateX(100%)'" style="font-size:24px; background:none; border:none; color:white;">‚Üê</button>
                <img id="header-avatar" class="avatar" src="">
                <span id="header-name" style="font-weight:bold; font-size:16px; margin-left:10px;">User</span>
            </div>
            <div class="messages-area" id="msg-box"></div>
        </div>
    </div>

    <div id="lightbox">
        <div class="lb-close" onclick="document.getElementById('lightbox').style.display='none'">√ó</div>
        <img id="lb-img" src="">
    </div>

    <script>
        // --- DB (Storage) ---
        const dbName="WA_Pro_DB"; let db;
        const req=indexedDB.open(dbName,1);
        req.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore("media",{keyPath:"id"});};
        req.onsuccess=e=>{db=e.target.result;};
        
        function saveLocal(id,c){if(db)db.transaction(["media"],"readwrite").objectStore("media").put({id,c});}
        function getLocal(id,cb){if(!db)return cb(null);db.transaction(["media"],"readonly").objectStore("media").get(id).onsuccess=e=>cb(e.target.result?e.target.result.c:null);}

        let currentBot=null, allChats=[], activeTab='chats';

        window.onload=()=>{ loadSessions(); }

        function loadSessions() {
            fetch('/api/sessions').then(r=>r.json()).then(res=>{
                const box=document.getElementById('session-list'); box.innerHTML='';
                res.forEach(num=>{
                    box.innerHTML+=`<div class="session-card" onclick="startApp('${num}')">
                    <div style="background:#00a884;color:white;width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;">üì±</div>
                    <div><div style="font-weight:bold;color:white;">${num}</div><div style="font-size:12px;color:#8696a0;">Tap to open</div></div></div>`;
                });
            });
        }

        function startApp(id){ currentBot=id; document.getElementById('home-view').style.display='none'; document.getElementById('app-view').style.display='block'; loadChats(); }

        async function loadChats(){
            document.getElementById('chat-list-box').innerHTML='<div style="text-align:center;padding:20px;color:#666;">Syncing...</div>';
            const res=await fetch(`/api/chats?bot_id=${currentBot}`);
            allChats=await res.json();
            renderList();
        }

        function renderList(){
            const list=document.getElementById('chat-list-box'); list.innerHTML='';
            const filtered=allChats.filter(c=>{
                if(activeTab==='groups')return c.type==='group';
                if(activeTab==='channels')return c.type==='channel';
                return c.type==='user';
            });
            filtered.forEach(c=>{
                const aid=`av_${c.id.replace(/[^a-zA-Z0-9]/g,'')}`;
                list.innerHTML+=`<div class="chat-item" onclick="openChat('${c.id}','${c.name}','${aid}')">
                <img id="${aid}" class="avatar" src="https://ui-avatars.com/api/?name=${c.name}&background=random">
                <div style="flex:1;overflow:hidden;"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                <div style="font-size:13px;color:#8696a0;">${c.id}</div></div></div>`;
                // Lazy Avatar
                fetch(`/api/avatar?bot_id=${currentBot}&chat_id=${c.id}`).then(r=>r.json()).then(d=>{if(d.url)document.getElementById(aid).src=d.url;}).catch(()=>{});
            });
        }

        function switchTab(t){ activeTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); renderList(); }

        async function openChat(cid,name,aid){
            document.getElementById('header-name').innerText=name;
            const src=document.getElementById(aid)?document.getElementById(aid).src:`https://ui-avatars.com/api/?name=${name}`;
            document.getElementById('header-avatar').src=src;
            
            const win=document.getElementById('chat-window'); win.style.transform='translateX(0)';
            const box=document.getElementById('msg-box'); box.innerHTML='<div style="text-align:center;padding:50px;">Loading History...</div>';

            const res=await fetch(`/api/messages?bot_id=${currentBot}&chat_id=${cid}`);
            const msgs=await res.json();
            box.innerHTML='';

            msgs.forEach(m=>{
                let c='';
                const t=m.is_from_me?'sent':'rec';
                const time=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const sender=(!m.is_from_me && m.is_group)?`<span class="sender-name">${m.sender_name}</span>`:'';

                if(m.type==='text') c=m.content;
                else if(m.type==='image') c=renderImage(m);
                else if(m.type==='audio') c=renderAudio(m);
                else if(m.type==='video') c=`<video src="${m.content}" style="width:100%;border-radius:6px;" controls></video>`;
                else c=`<a href="${m.content}" target="_blank" style="color:#00a884;">üìÑ Attachment</a>`;

                box.innerHTML+=`<div class="msg ${t}">${sender} ${c} <span class="time">${time}</span></div>`;
            });
            box.scrollTop=box.scrollHeight;
        }

        // --- üéµ AUDIO PLAYER LOGIC ---
        function renderAudio(m) {
            const uid = m.message_id;
            // HTML Structure for Player
            return `
            <div id="player-${uid}" class="wa-audio-player">
                <div class="control-btn" onclick="handleAudioClick('${uid}', this)">
                    <span class="icon dl show">‚¨á</span> <span class="icon play">‚ñ∂</span> <span class="icon pause">‚è∏</span> <div class="spinner"></div> </div>
                <div class="audio-info">
                    <div class="progress-bar"><div class="progress-fill"></div></div>
                    <div class="audio-meta">Voice Note</div>
                </div>
                <audio id="audio-${uid}" style="display:none;" onended="resetPlayer('${uid}')"></audio>
            </div>
            <script>checkLocalAudio('${uid}','${m.content}')<\/script>`;
        }

        // JS to check if we already downloaded
        window.checkLocalAudio = function(uid, serverContent) {
            if(serverContent === 'MEDIA_WAITING') {
                // Check IndexedDB
                getLocal(uid, (data) => {
                    if(data) {
                        setupAudioSource(uid, data);
                    }
                });
            } else {
                // It's a link (Catbox)
                setupAudioSource(uid, serverContent);
            }
        }

        window.handleAudioClick = function(uid, btn) {
            const audio = document.getElementById(`audio-${uid}`);
            const dlIcon = btn.querySelector('.dl');
            const playIcon = btn.querySelector('.play');
            const pauseIcon = btn.querySelector('.pause');
            const spinner = btn.querySelector('.spinner');

            // 1. If not ready (Download needed)
            if(!audio.src) {
                // Show Spinner
                dlIcon.classList.remove('show');
                spinner.classList.add('show');
                
                // Fetch
                fetch(`/api/media?msg_id=${uid}`).then(r=>r.json()).then(d=>{
                    if(d.content) {
                        saveLocal(uid, d.content);
                        setupAudioSource(uid, d.content);
                        // Hide Spinner, Show Play, and Auto Play
                        spinner.classList.remove('show');
                        playIcon.classList.add('show');
                        audio.play();
                        toggleIcons(uid, 'pause');
                    } else {
                        alert("Download Failed");
                        spinner.classList.remove('show');
                        dlIcon.classList.add('show');
                    }
                });
            } 
            // 2. If Playing -> Pause
            else if(!audio.paused) {
                audio.pause();
                toggleIcons(uid, 'play');
            } 
            // 3. If Paused -> Play
            else {
                audio.play();
                toggleIcons(uid, 'pause');
            }
        }

        function setupAudioSource(uid, src) {
            const audio = document.getElementById(`audio-${uid}`);
            const btn = document.getElementById(`player-${uid}`).querySelector('.control-btn');
            
            audio.src = src;
            
            // Remove DL icon, Show Play icon
            btn.querySelector('.dl').classList.remove('show');
            btn.querySelector('.spinner').classList.remove('show');
            btn.querySelector('.play').classList.add('show');
        }

        function toggleIcons(uid, state) {
            const btn = document.getElementById(`player-${uid}`).querySelector('.control-btn');
            if(state === 'play') {
                btn.querySelector('.pause').classList.remove('show');
                btn.querySelector('.play').classList.add('show');
            } else {
                btn.querySelector('.play').classList.remove('show');
                btn.querySelector('.pause').classList.add('show');
            }
        }

        window.resetPlayer = function(uid) {
            toggleIcons(uid, 'play');
        }

        // --- üì∑ IMAGE LOGIC ---
        function renderImage(m) {
            const uid=m.message_id;
            if(m.content==='MEDIA_WAITING'){
                // Check local DB
                setTimeout(()=>{
                    getLocal(uid,(d)=>{
                        if(d) document.getElementById(`img-box-${uid}`).innerHTML=`<img src="${d}" class="chat-img" onclick="showLightbox(this.src)">`;
                    });
                },0);
                
                return `<div id="img-box-${uid}" class="img-blur-box" onclick="downloadImage('${uid}',this)">
                    <div class="dl-circle">‚¨á</div>
                </div>`;
            }
            return `<img src="${m.content}" class="chat-img" onclick="showLightbox(this.src)">`;
        }

        function downloadImage(uid, el) {
            el.innerHTML = `<div class="dl-circle" style="border-top-color:transparent; animation:spin 1s linear infinite;"></div>`;
            fetch(`/api/media?msg_id=${uid}`).then(r=>r.json()).then(d=>{
                if(d.content){
                    saveLocal(uid, d.content);
                    el.outerHTML = `<img src="${d.content}" class="chat-img" onclick="showLightbox(this.src)">`;
                }
            });
        }

        function showLightbox(src){ document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; }

    </script>
</body>
</html>