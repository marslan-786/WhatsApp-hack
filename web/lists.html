<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>WhatsApp VIP</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark:#0b141a;
      --bg-panel:#111b21;
      --primary:#00a884;
      --bubble-sent:#005c4b;
      --bubble-rec:#202c33;
      --text-main:#e9edef;
      --text-muted:#8696a0;
      --border:#222d34;
      --card:#0f1a20;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; font-family:'Inter',sans-serif; background:var(--bg-dark); color:var(--text-main);
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
    }
    ::-webkit-scrollbar{ width:5px; }
    ::-webkit-scrollbar-thumb{ background:#374045; border-radius:3px; }

    /* ---------------- Splash ---------------- */
    #splash{
      position:fixed; inset:0; z-index:999;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(0,168,132,.12), transparent 60%),
                  radial-gradient(900px 700px at 20% 80%, rgba(0,168,132,.10), transparent 55%),
                  var(--bg-dark);
    }
    .splash-wrap{
      width:280px; max-width:80vw;
      display:flex; flex-direction:column; align-items:center; gap:18px;
      transform: translateY(-10px);
    }
    .wa-logo{
      width:120px; height:120px; position:relative;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.45));
    }
    .wa-logo .circle{
      width:120px; height:120px; border-radius:50%;
      background: linear-gradient(180deg, rgba(0,168,132,.95), rgba(0,168,132,.75));
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    /* pic.png ⁄©Ÿà ⁄ØŸàŸÑ ⁄©€í ÿßŸÜÿØÿ± zoom + crop */
    .wa-logo .circle img{
      width:115%; height:115%;
      object-fit:cover;
      transform: scale(1.12); /* zoom */
      filter: saturate(1.05) contrast(1.05);
      border-radius:50%;
    }
    .wa-logo .tail{
      position:absolute; left:18px; bottom:-12px;
      width:44px; height:44px;
      background: linear-gradient(180deg, rgba(0,168,132,.95), rgba(0,168,132,.75));
      transform: rotate(20deg);
      border-bottom-left-radius: 46px;
      border-top-right-radius: 46px;
      border-top-left-radius: 12px;
      border-bottom-right-radius: 10px;
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
    }
    .splash-title{
      font-weight:700; letter-spacing:.6px;
      color:rgba(233,237,239,.95);
      font-size:16px;
    }
    .splash-sub{
      color:rgba(134,150,160,.95);
      font-size:12px; text-align:center; line-height:1.4;
    }
    .loader{
      width:160px; height:5px; border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden; position:relative;
      border: 1px solid rgba(255,255,255,.06);
    }
    .loader::after{
      content:""; position:absolute; inset:0;
      width:45%; height:100%;
      background: linear-gradient(90deg, transparent, rgba(0,168,132,.9), transparent);
      transform: translateX(-60%);
      animation: load 1.1s infinite ease-in-out;
    }
    @keyframes load{
      0%{ transform: translateX(-60%); }
      100%{ transform: translateX(220%); }
    }

    /* ---------------- Home (Sessions) ---------------- */
    #home-view{
      width:100%; height:100%;
      display:flex; flex-direction:column; align-items:center;
      padding:16px; overflow-y:auto;
    }
    .topbar{
      width:100%; max-width:520px;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 12px;
      position:sticky; top:0;
      background: rgba(11,20,26,.85);
      backdrop-filter: blur(12px);
      z-index:5;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .brand-badge{
      width:34px; height:34px; border-radius:12px;
      background: rgba(0,168,132,.18);
      border:1px solid rgba(0,168,132,.22);
      display:flex; align-items:center; justify-content:center;
      color: var(--primary);
      font-weight:800;
    }
    .brand-title{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand-title b{ font-size:14px; }
    .brand-title span{ font-size:11px; color: var(--text-muted); }

    #session-list{
      width:100%; max-width:520px;
      display:flex; flex-direction:column;
      gap:10px; padding:14px 0 40px;
    }

    .session-card{
      background: linear-gradient(180deg, rgba(17,27,33,.96), rgba(15,26,32,.96));
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      padding:14px;
      display:flex; align-items:center; gap:12px;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      transition: transform .14s ease, border-color .14s ease;
    }
    .session-card:active{ transform: scale(.99); }
    .session-ico{
      width:46px; height:46px; border-radius:16px;
      background: rgba(0,168,132,.16);
      border: 1px solid rgba(0,168,132,.20);
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .pulse{
      position:absolute; right:-2px; bottom:-2px;
      width:12px; height:12px; border-radius:50%;
      background: #32d074;
      box-shadow: 0 0 0 0 rgba(50,208,116,.55);
      animation: pulse 1.6s infinite;
      border:2px solid var(--bg-panel);
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(50,208,116,.55); }
      70%{ box-shadow: 0 0 0 10px rgba(50,208,116,0); }
      100%{ box-shadow: 0 0 0 0 rgba(50,208,116,0); }
    }
    .session-meta{ flex:1; min-width:0; }
    .session-meta .num{
      font-weight:700; font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .session-meta .sub{
      font-size:11px; color: var(--text-muted);
      margin-top:2px;
    }
    .enter{
      font-size:12px; color: rgba(233,237,239,.9);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.06);
      padding:8px 10px; border-radius:12px;
    }

    /* ---------------- App (Chats/Groups/Status) ---------------- */
    #app-view{ display:none; width:100%; height:100%; position:relative; }
    .sidebar{
      width:100%; height:100%;
      display:flex; flex-direction:column;
      background: var(--bg-panel);
    }
    .app-header{
      height:64px; background: rgba(17,27,33,.92);
      backdrop-filter: blur(10px);
      display:flex; justify-content:space-between; align-items:center;
      padding:0 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .app-header .title{
      font-weight:800; letter-spacing:.2px;
    }
    .app-header button{
      background: rgba(241,92,109,.12);
      border: 1px solid rgba(241,92,109,.20);
      color: #f15c6d;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }

    .tabs{
      display:flex;
      background: rgba(17,27,33,.92);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .tab-btn{
      flex:1; padding:12px;
      border:none; background:none;
      color: var(--text-muted);
      font-weight:700;
      cursor:pointer;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active{
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .banner{
      display:none;
      margin:10px 12px 0;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,168,132,.12);
      border: 1px solid rgba(0,168,132,.18);
      color: rgba(233,237,239,.95);
      font-size:12px;
    }
    .banner.show{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .banner button{
      background: rgba(0,168,132,.18);
      color: rgba(233,237,239,.95);
      border: 1px solid rgba(0,168,132,.22);
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    .chat-list{
      flex:1;
      overflow-y:auto;
      padding: 6px 0 90px;
    }
    .chat-item{
      display:flex;
      padding:12px 14px;
      align-items:center;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
      cursor:pointer;
      transition: background .14s ease;
    }
    .chat-item:hover{ background: rgba(255,255,255,.03); }
    .avatar{
      width:46px; height:46px;
      border-radius:50%;
      background:#6a7f8a;
      object-fit:cover;
      flex-shrink:0;
    }
    .chat-mid{ flex:1; min-width:0; }
    .chat-mid .name{
      font-weight:800; font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chat-mid .sub{
      margin-top:2px;
      font-size:12px; color: var(--text-muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chat-right{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
    }
    .badge{
      min-width:20px; height:20px;
      border-radius:999px;
      background: var(--primary);
      color:#072b23;
      display:none;
      align-items:center; justify-content:center;
      font-size:12px;
      font-weight:900;
      padding:0 6px;
    }
    .badge.show{ display:flex; }
    .tiny-time{
      font-size:10px; color: rgba(134,150,160,.95);
    }

    /* ---------------- Chat Window ---------------- */
    #chat-window{
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background: var(--bg-dark);
      z-index:50;
      display:flex; flex-direction:column;
      transform: translateX(100%);
      transition: transform .28s cubic-bezier(.2,.8,.2,1);
    }
    .chat-nav{
      height:64px;
      background: rgba(17,27,33,.92);
      backdrop-filter: blur(10px);
      display:flex; align-items:center;
      padding:0 10px;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .chat-nav button{
      font-size:22px; background:none; border:none; color:white;
      cursor:pointer;
    }
    .chat-nav .head{
      flex:1; min-width:0;
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .chat-nav .head b{
      font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chat-nav .head span{
      font-size:11px; color: var(--text-muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .info-btn{
      width:38px; height:38px; border-radius:12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      color: rgba(233,237,239,.95);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      font-weight:900;
    }

    .messages-area{
      flex:1; overflow-y:auto;
      padding: 14px 12px 70px;
      display:flex; flex-direction:column; gap:6px;
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      background-size: 420px;
      opacity:.97;
    }

    .msg{
      max-width: 84%;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 14.5px;
      position: relative;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
      color: #e9edef;
      line-height: 1.4;
      word-wrap: break-word;
      display:flex; flex-direction:column;
    }
    .msg.sent{ align-self:flex-end; background: var(--bubble-sent); border-top-right-radius: 4px; }
    .msg.rec{ align-self:flex-start; background: var(--bubble-rec); border-top-left-radius: 4px; }

    .msg.sticker{ background: transparent !important; box-shadow:none !important; padding:0; }
    .sender-name{ font-size:12px; color:#f2c94c; font-weight:800; margin-bottom:2px; }
    .time{ font-size:10px; color: rgba(255,255,255,.60); align-self:flex-end; margin-top:4px; }

    .reply-box{
      background: rgba(0,0,0,0.16);
      border-left: 4px solid var(--primary);
      border-radius: 6px;
      padding: 6px 8px;
      margin-bottom: 6px;
      font-size: 12px;
      display:flex; flex-direction:column;
      cursor:pointer;
    }
    .reply-sender{ color: var(--primary); font-weight:900; font-size:11px; margin-bottom:2px; }
    .reply-text{ color: rgba(255,255,255,.72); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Media placeholders like WA */
    .media-wrap{
      position:relative; border-radius:10px; overflow:hidden;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.06);
    }
    img.chat-img{ width: 240px; max-width: 100%; display:block; border-radius:10px; }
    img.sticker-img{ width: 140px; height:auto; object-fit:contain; display:block; }

    .media-overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(3px);
      cursor:pointer;
    }
    .dl-btn{
      width:52px; height:52px; border-radius:50%;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      color:white; font-size:20px; font-weight:900;
    }

    /* Audio WA-like */
    .wa-audio{
      width: 260px; max-width: 100%;
      padding:10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; gap:10px;
    }
    .wa-audio .pbtn{
      width:44px; height:44px; border-radius:50%;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      cursor:pointer;
      flex-shrink:0;
    }
    .wa-audio .meta{ flex:1; min-width:0; }
    .wa-audio .bar{
      height:4px; border-radius:999px;
      background: rgba(255,255,255,.18);
      overflow:hidden;
      margin-top:6px;
    }
    .wa-audio .bar i{
      display:block; height:100%;
      width:0%;
      background: rgba(0,168,132,.95);
    }

    .secure-footer{
      text-align:center; font-size:10px; color: var(--text-muted);
      background: rgba(11,20,26,0.92);
      padding: 12px 14px;
      margin: 14px auto 0;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center; gap:6px;
      width: fit-content;
      border: 1px solid rgba(255,255,255,.06);
    }

    /* Lightbox */
    #lightbox{ display:none; position:fixed; inset:0; background:black; z-index:100; align-items:center; justify-content:center; }
    #lightbox img{ max-width:100%; max-height:100%; }
    .lb-close{ position:absolute; top:20px; left:20px; color:white; font-size:30px; cursor:pointer; }

    /* Tiny toast (non-blocking) */
    #toast{
      position: fixed; left:50%; bottom:18px;
      transform: translateX(-50%) translateY(20px);
      opacity:0;
      background: rgba(17,27,33,.92);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(233,237,239,.95);
      font-size: 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: var(--shadow);
      z-index: 120;
      transition: opacity .18s ease, transform .18s ease;
      max-width: 92vw;
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    #toast b{ color: var(--primary); }
    #toast button{
      margin-left:auto;
      background: rgba(0,168,132,.14);
      border: 1px solid rgba(0,168,132,.18);
      color: rgba(233,237,239,.95);
      border-radius: 12px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
  </style>
</head>

<body>

  <!-- Splash -->
  <div id="splash">
    <div class="splash-wrap">
      <div class="wa-logo">
        <div class="circle">
          <img src="/pic.png" alt="logo">
        </div>
        <div class="tail"></div>
      </div>
      <div class="splash-title">WHATSAPP VIP</div>
      <div class="splash-sub">Loading sessions & syncing chats‚Ä¶</div>
      <div class="loader"></div>
    </div>
  </div>

  <!-- Home -->
  <div id="home-view">
    <div class="topbar">
      <div class="brand">
        <div class="brand-badge">W</div>
        <div class="brand-title">
          <b>WhatsApp VIP</b>
          <span>Choose a live session</span>
        </div>
      </div>
      <div style="color:var(--text-muted); font-size:12px;">‚óè Live</div>
    </div>
    <div id="session-list"></div>
  </div>

  <!-- App -->
  <div id="app-view">
    <div class="sidebar">
      <div class="app-header">
        <div class="title">WhatsApp</div>
        <button onclick="exitApp()">EXIT</button>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('chats', event)">Chats</button>
        <button class="tab-btn" onclick="switchTab('groups', event)">Groups</button>
        <button class="tab-btn" onclick="switchTab('status', event)">Status</button>
      </div>

      <div id="top-banner" class="banner">
        <span id="banner-text">New updates</span>
        <button onclick="clearBanner()">OK</button>
      </div>

      <div class="chat-list" id="chat-list-box"></div>
    </div>

    <div id="chat-window">
      <div class="chat-nav">
        <button onclick="closeChat()">‚Üê</button>
        <img id="header-avatar" class="avatar" src="">
        <div class="head">
          <b id="header-name">User</b>
          <span id="header-sub">Online</span>
        </div>
        <div class="info-btn" onclick="showInfo()">i</div>
      </div>
      <div class="messages-area" id="msg-box"></div>
    </div>
  </div>

  <div id="lightbox">
    <div class="lb-close" onclick="document.getElementById('lightbox').style.display='none'">√ó</div>
    <img id="lb-img" src="">
  </div>

  <div id="toast">
    <span id="toast-text">New message</span>
    <button onclick="hideToast()">View</button>
  </div>

<script>
/* ---------------- IndexedDB (fast cache) ---------------- */
const DB_NAME = "WA_VIP_DB";
let db = null;

function openDB(){
  return new Promise((resolve) => {
    const req = indexedDB.open(DB_NAME, 2);
    req.onupgradeneeded = (e) => {
      db = e.target.result;
      if(!db.objectStoreNames.contains("media")) db.createObjectStore("media", { keyPath:"id" });
      if(!db.objectStoreNames.contains("chats")) db.createObjectStore("chats", { keyPath:"key" }); // key = bot|type
      if(!db.objectStoreNames.contains("messages")) db.createObjectStore("messages", { keyPath:"key" }); // key = bot|chat|message_id
      if(!db.objectStoreNames.contains("unread")) db.createObjectStore("unread", { keyPath:"key" }); // key = bot|chat
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(true); };
    req.onerror = () => resolve(false);
  });
}
function put(store, val){
  return new Promise((resolve) => {
    if(!db) return resolve(false);
    const tx = db.transaction([store], "readwrite");
    tx.objectStore(store).put(val);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}
function get(store, key){
  return new Promise((resolve) => {
    if(!db) return resolve(null);
    const tx = db.transaction([store], "readonly");
    const req = tx.objectStore(store).get(key);
    req.onsuccess = (e) => resolve(e.target.result || null);
    req.onerror = () => resolve(null);
  });
}
function getAll(store){
  return new Promise((resolve) => {
    if(!db) return resolve([]);
    const tx = db.transaction([store], "readonly");
    const req = tx.objectStore(store).getAll();
    req.onsuccess = (e) => resolve(e.target.result || []);
    req.onerror = () => resolve([]);
  });
}

/* ---------------- Existing media cache helpers ---------------- */
function saveLocal(id,c){ if(db) db.transaction(["media"],"readwrite").objectStore("media").put({id,c}); }
function getLocal(id,cb){ if(!db) return cb(null); db.transaction(["media"],"readonly").objectStore("media").get(id).onsuccess=e=>cb(e.target.result?e.target.result.c:null); }

/* ---------------- State ---------------- */
let currentBot = null;
let allChats = [];
let activeTab = 'chats';
let activeChatID = null;
let pollInterval = null;
let knownMessageIDs = new Set();
let unreadMap = new Map(); // chat_id => count
let lastToastChat = null;

window.onload = async () => {
  await openDB();

  // splash 3s
  setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
  }, 3000);

  loadSessions();
  restoreUnread();
};

function exitApp(){
  currentBot=null;
  activeChatID=null;
  if(pollInterval) clearInterval(pollInterval);
  document.getElementById('app-view').style.display='none';
  document.getElementById('home-view').style.display='flex';
  loadSessions();
}

function showToast(text, chatID){
  lastToastChat = chatID || null;
  document.getElementById('toast-text').innerHTML = text;
  document.getElementById('toast').classList.add('show');
  setTimeout(() => hideToast(), 4000);
}
function hideToast(){
  document.getElementById('toast').classList.remove('show');
}
document.querySelector('#toast button').onclick = () => {
  hideToast();
  if(lastToastChat){
    const c = allChats.find(x => x.id === lastToastChat);
    if(c) openChat(c.id, c.name);
  }
};

/* ---------------- Banner ---------------- */
function showBanner(msg){
  const b = document.getElementById('top-banner');
  document.getElementById('banner-text').innerText = msg;
  b.classList.add('show');
  setTimeout(() => b.classList.remove('show'), 5000);
}
function clearBanner(){ document.getElementById('top-banner').classList.remove('show'); }

/* ---------------- Sessions ---------------- */
function loadSessions() {
  fetch('/api/sessions').then(r=>r.json()).then(res=>{
    const box=document.getElementById('session-list');
    box.innerHTML='';
    res.forEach(num=>{
      box.innerHTML += `
        <div class="session-card" onclick="startApp('${num}')">
          <div class="session-ico">üì±<div class="pulse"></div></div>
          <div class="session-meta">
            <div class="num">${num}</div>
            <div class="sub">Tap to open chats</div>
          </div>
          <div class="enter">OPEN</div>
        </div>`;
    });
  }).catch(()=>{
    showBanner("Failed to load sessions (network).");
  });
}

async function startApp(id){
  currentBot=id;
  document.getElementById('home-view').style.display='none';
  document.getElementById('app-view').style.display='block';

  // Load cached chats instantly
  await loadChatsFromCache();
  renderList();

  // Then refresh from server in background
  loadChatsFromServer();
}

/* ---------------- Chats cache ---------------- */
async function loadChatsFromCache(){
  const key = `${currentBot}|chats`;
  const cached = await get("chats", key);
  allChats = cached?.data || [];
}

async function saveChatsToCache(){
  const key = `${currentBot}|chats`;
  await put("chats", { key, data: allChats, updated_at: Date.now() });
}

async function loadChatsFromServer(){
  try{
    const res = await fetch(`/api/chats?bot_id=${encodeURIComponent(currentBot)}`);
    const fresh = await res.json();
    if(Array.isArray(fresh)){
      allChats = fresh;
      await saveChatsToCache();
      renderList();
    }
  }catch(e){
    showBanner("Using cached chats (server unreachable).");
  }
}

/* ---------------- Unread ---------------- */
async function restoreUnread(){
  const all = await getAll("unread");
  all.forEach(x => {
    const parts = (x.key || "").split("|");
    if(parts.length === 2){
      const chatID = parts[1];
      unreadMap.set(chatID, x.count || 0);
    }
  });
}
async function setUnread(botID, chatID, count){
  unreadMap.set(chatID, count);
  await put("unread", { key: `${botID}|${chatID}`, count, updated_at: Date.now() });
}
async function incUnread(botID, chatID){
  const cur = unreadMap.get(chatID) || 0;
  await setUnread(botID, chatID, cur+1);
}
async function clearUnread(botID, chatID){
  await setUnread(botID, chatID, 0);
}

/* ---------------- Tabs & list ---------------- */
function switchTab(t, ev){
  activeTab = t;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  if(ev && ev.target) ev.target.classList.add('active');
  renderList();
}

function renderList(){
  const list = document.getElementById('chat-list-box');
  list.innerHTML='';

  const filtered = allChats.filter(c=>{
    if(activeTab==='groups') return c.type==='group';
    if(activeTab==='status') return c.type==='status'; // ÿß⁄Øÿ± backend ŸÜ€í status chats list ŸÖ€å⁄∫ add ⁄©€å
    return c.type==='user';
  });

  if(filtered.length === 0){
    list.innerHTML = `<div style="padding:18px;color:var(--text-muted);font-size:12px;">
      No items. (Tab: ${activeTab})
    </div>`;
    return;
  }

  filtered.forEach(c=>{
    const aid = `av_${(c.id||'').replace(/[^a-zA-Z0-9]/g,'')}`;
    const badgeCount = unreadMap.get(c.id) || 0;

    list.innerHTML += `
      <div class="chat-item" onclick="openChat('${escapeHTML(c.id)}','${escapeHTML(c.name)}')">
        <img id="${aid}" class="avatar" src="https://ui-avatars.com/api/?name=${encodeURIComponent(c.name)}&background=0b141a&color=e9edef">
        <div class="chat-mid">
          <div class="name">${escapeHTML(c.name)}</div>
          <div class="sub">${escapeHTML(prettyChatSub(c))}</div>
        </div>
        <div class="chat-right">
          <div class="badge ${badgeCount>0?'show':''}">${badgeCount}</div>
        </div>
      </div>`;

    // avatar background fetch
    fetch(`/api/avatar?bot_id=${encodeURIComponent(currentBot)}&chat_id=${encodeURIComponent(c.id)}`)
      .then(r=>r.json())
      .then(d=>{ if(d && d.url) { const img = document.getElementById(aid); if(img) img.src = d.url; }})
      .catch(()=>{});
  });
}

function prettyChatSub(c){
  // Prefer showing number instead of LID
  // If chat id contains @s.whatsapp.net => show number part
  if((c.id||'').includes('@')){
    return (c.id.split('@')[0] || c.id);
  }
  return c.id || '';
}

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ---------------- Messages caching ---------------- */
function msgKey(bot, chat, mid){ return `${bot}|${chat}|${mid}`; }
async function saveMessagesToCache(bot, chat, msgs){
  for(const m of msgs){
    if(!m || !m.message_id) continue;
    await put("messages", { key: msgKey(bot, chat, m.message_id), bot, chat, m });
  }
}
async function loadCachedMessages(bot, chat){
  const all = await getAll("messages");
  const out = all
    .filter(x => x.bot === bot && x.chat === chat)
    .map(x => x.m)
    .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
  return out;
}

/* ---------------- Chat open & background sync ---------------- */
async function openChat(cid, name){
  activeChatID = cid;

  document.getElementById('header-name').innerText = name;
  document.getElementById('header-sub').innerText = cid.includes('@g.us') ? 'Group' : (cid.includes('@newsletter') ? 'Channel' : (cid.split('@')[0] || cid));
  document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0b141a&color=e9edef`;

  const win=document.getElementById('chat-window');
  win.style.transform='translateX(0)';

  // mark unread cleared
  await clearUnread(currentBot, cid);
  renderList();

  const box = document.getElementById('msg-box');
  box.innerHTML = '';

  knownMessageIDs.clear();

  // 1) Load cached messages instantly
  const cached = await loadCachedMessages(currentBot, cid);
  if(cached.length){
    cached.forEach(m => knownMessageIDs.add(m.message_id));
    renderMessagesInto(box, cached, true);
  }else{
    // show in-chat loading (VIP style)
    box.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px;padding:34px;color:var(--text-muted);">
        <div class="wa-logo" style="transform:scale(.75);">
          <div class="circle"><img src="/pic.png" alt="logo"></div>
          <div class="tail"></div>
        </div>
        <div style="font-size:12px;">Loading messages‚Ä¶</div>
        <div class="loader" style="width:140px;"></div>
      </div>`;
  }

  // 2) Background fetch from server (no blocking popup)
  await syncMessagesFromServer(cid, box, true);

  // 3) Start polling ONLY for open chat
  if(pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(() => syncMessagesFromServer(cid, box, false), 3500);
}

async function syncMessagesFromServer(cid, box, first){
  if(activeChatID !== cid) return;

  try{
    const res = await fetch(`/api/messages?bot_id=${encodeURIComponent(currentBot)}&chat_id=${encodeURIComponent(cid)}`);
    const msgs = await res.json();

    // old backend returns array; if future returns object, handle it too
    const arr = Array.isArray(msgs) ? msgs : (msgs && msgs.messages ? msgs.messages : []);
    if(!Array.isArray(arr)) return;

    // Merge only new by message_id
    const newOnes = [];
    for(const m of arr){
      if(!m || !m.message_id) continue;
      if(knownMessageIDs.has(m.message_id)) continue;
      knownMessageIDs.add(m.message_id);
      newOnes.push(m);
    }

    if(newOnes.length){
      // cache + render
      await saveMessagesToCache(currentBot, cid, newOnes);
      renderMessagesInto(box, newOnes, false);

      // subtle banner
      showBanner(`‚úÖ ${newOnes.length} new message(s) in open chat`);
      // keep scrolled bottom if user near bottom
      const nearBottom = (box.scrollHeight - box.scrollTop - box.clientHeight) < 140;
      if(nearBottom) box.scrollTop = box.scrollHeight;
    }else if(first && !knownMessageIDs.size && arr.length){
      // first load and we didn't have cache (loading screen was showing)
      box.innerHTML = '';
      arr.forEach(m => { if(m && m.message_id) knownMessageIDs.add(m.message_id); });
      await saveMessagesToCache(currentBot, cid, arr);
      renderMessagesInto(box, arr, true);
    }

  }catch(e){
    if(first) showBanner("‚ö†Ô∏è Messages: using cache (server issue).");
  }
}

function closeChat(){
  document.getElementById('chat-window').style.transform='translateX(100%)';
  if(pollInterval) clearInterval(pollInterval);
  activeChatID = null;
}

/* ---------------- Render messages (WA-like) ---------------- */
function renderMessagesInto(box, msgs, isFirstLoad){
  if(isFirstLoad){
    box.innerHTML = '';
  }

  msgs.forEach(m=>{
    const t = m.is_from_me ? 'sent' : 'rec';
    const time = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const nameTag = (!m.is_from_me && m.is_group) ? `<span class="sender-name">${escapeHTML(m.sender_name || '')}</span>` : '';

    let replyHtml = '';
    if(m.quoted_msg){
      replyHtml = `
        <div class="reply-box">
          <div class="reply-sender">${escapeHTML(m.quoted_sender || 'Unknown')}</div>
          <div class="reply-text">${escapeHTML(m.quoted_msg || '')}</div>
        </div>`;
    }

    let content = '';
    if(m.is_sticker){
      content = renderImage(m, true);
    } else if(m.type === 'text') {
      content = escapeHTML(m.content || '');
    } else if(m.type === 'image') {
      content = renderImage(m, false);
    } else if(m.type === 'audio') {
      content = renderAudio(m);
    } else if(m.type === 'video') {
      content = renderVideo(m);
    } else {
      content = renderFile(m);
    }

    const div = document.createElement('div');
    div.className = m.is_sticker ? `msg sticker ${t}` : `msg ${t}`;

    if(m.is_sticker){
      div.innerHTML = `${content}<span class="time" style="text-shadow:1px 1px 2px black;">${time}</span>`;
    }else{
      div.innerHTML = `${replyHtml}${nameTag}${content}<span class="time">${time}</span>`;
    }

    box.appendChild(div);
  });

  if(isFirstLoad){
    const footer = document.createElement('div');
    footer.className = "secure-footer";
    footer.innerHTML = "üîí End-to-end Encrypted";
    box.appendChild(footer);
    box.scrollTop = box.scrollHeight;
  }
}

/* ---------------- Media (WA placeholder + on-demand download) ---------------- */
function renderImage(m, isSticker){
  const uid = m.message_id;
  const className = isSticker ? "sticker-img" : "chat-img";

  // New backend method: messages content is MEDIA_WAITING
  if(m.content === 'MEDIA_WAITING'){
    // show blurred placeholder with download button
    setTimeout(()=>{
      getLocal(uid, (data)=>{
        if(data){
          const el = document.getElementById(`img-${uid}`);
          if(el) el.src = data;
          const ov = document.getElementById(`ov-${uid}`);
          if(ov) ov.style.display = 'none';
        }
      });
    },0);

    return `
      <div class="media-wrap">
        <img id="img-${uid}" class="${className}" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgZmlsbD0iIzE1MjEyOSIgcng9IjEyIi8+PHRleHQgeD0iNTAiIHk9Ijg4IiBmaWxsPSIjODY5NmEwIiBmb250LXNpemU9IjEyIj5NZW
RpYSBub3QgZG93bmxvYWRlZDwvdGV4dD48L3N2Zz4=" onclick="showLightbox(this.src)">
        <div id="ov-${uid}" class="media-overlay" onclick="downloadMedia('${uid}', 'img-${uid}', 'ov-${uid}')">
          <div class="dl-btn">‚¨á</div>
        </div>
      </div>`;
  }

  // already has url/base64
  return `<div class="media-wrap">
    <img src="${m.content}" class="${className}" onclick="showLightbox(this.src)">
  </div>`;
}

function renderAudio(m){
  const uid = m.message_id;

  if(m.content === 'MEDIA_WAITING'){
    // try cached
    setTimeout(()=>{
      getLocal(uid, (data)=>{
        if(data) setupAudio(uid, data);
      });
    },0);

    return `
      <div id="aud-${uid}" class="wa-audio">
        <div class="pbtn" onclick="downloadAudio('${uid}', this)">‚¨á</div>
        <div class="meta">
          <div style="font-size:12px;color:rgba(233,237,239,.92);font-weight:800;">Voice message</div>
          <div class="bar"><i id="bar-${uid}"></i></div>
        </div>
        <audio id="audio-${uid}"></audio>
      </div>`;
  }

  return `<div class="wa-audio">
    <div class="pbtn" onclick="(function(){const a=document.getElementById('a-${uid}'); a.paused?a.play():a.pause();})()">‚ñ∂</div>
    <div class="meta">
      <audio id="a-${uid}" src="${m.content}" controls style="height:32px; width:100%; filter:invert(.92);"></audio>
    </div>
  </div>`;
}

function renderVideo(m){
  const uid = m.message_id;
  if(m.content === 'MEDIA_WAITING'){
    return `
      <div class="media-wrap" style="width:260px;max-width:100%;">
        <div style="padding:18px;color:var(--text-muted);font-size:12px;">Video not downloaded</div>
        <div id="ov-${uid}" class="media-overlay" onclick="downloadVideo('${uid}', 'ov-${uid}')">
          <div class="dl-btn">‚¨á</div>
        </div>
      </div>`;
  }
  return `<div class="media-wrap" style="width:260px;max-width:100%;">
    <video src="${m.content}" style="width:100%;border-radius:10px;display:block;" controls></video>
  </div>`;
}

function renderFile(m){
  const uid = m.message_id;
  if(m.content === 'MEDIA_WAITING'){
    return `<div class="media-wrap" style="padding:12px 12px;border-radius:12px;">
      <div style="color:rgba(233,237,239,.92);font-weight:800;">Attachment</div>
      <div style="color:var(--text-muted);font-size:12px;margin-top:4px;">Tap to download</div>
      <div style="margin-top:10px;">
        <button onclick="downloadFile('${uid}')" style="background:rgba(0,168,132,.14);border:1px solid rgba(0,168,132,.18);color:#e9edef;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;">‚¨á Download</button>
      </div>
    </div>`;
  }
  return `<a href="${m.content}" target="_blank" style="color:#00a884;font-weight:800;">üìÑ Attachment</a>`;
}

/* ---------------- Download handlers (calls /api/media) ---------------- */
async function downloadMedia(uid, imgID, overlayID){
  try{
    const r = await fetch(`/api/media?msg_id=${encodeURIComponent(uid)}`);
    const d = await r.json();
    if(d && d.content){
      saveLocal(uid, d.content);
      const img = document.getElementById(imgID);
      if(img) img.src = d.content;
      const ov = document.getElementById(overlayID);
      if(ov) ov.style.display='none';
      showToast(`<b>Downloaded</b> image`, activeChatID);
    }
  }catch(e){
    showBanner("‚ùå Failed to download media");
  }
}

async function downloadAudio(uid, btn){
  const audio = document.getElementById(`audio-${uid}`);
  if(!audio) return;

  // if audio not downloaded yet
  if(!audio.src){
    btn.innerText = "‚Ä¶";
    try{
      const r = await fetch(`/api/media?msg_id=${encodeURIComponent(uid)}`);
      const d = await r.json();
      if(d && d.content){
        saveLocal(uid, d.content);
        audio.src = d.content;
        btn.innerText = "‚ñ∂";
        audio.play();
      }else{
        btn.innerText = "‚¨á";
      }
    }catch(e){
      btn.innerText = "‚¨á";
      showBanner("‚ùå Failed to download audio");
    }
  }else{
    audio.paused ? audio.play() : audio.pause();
  }
}

async function downloadVideo(uid, overlayID){
  try{
    const r = await fetch(`/api/media?msg_id=${encodeURIComponent(uid)}`);
    const d = await r.json();
    if(d && d.content){
      // replace overlay with player
      const ov = document.getElementById(overlayID);
      if(ov && ov.parentElement){
        ov.parentElement.innerHTML = `<video src="${d.content}" style="width:100%;border-radius:10px;display:block;" controls autoplay></video>`;
      }
      showToast(`<b>Downloaded</b> video`, activeChatID);
    }
  }catch(e){
    showBanner("‚ùå Failed to download video");
  }
}

async function downloadFile(uid){
  try{
    const r = await fetch(`/api/media?msg_id=${encodeURIComponent(uid)}`);
    const d = await r.json();
    if(d && d.content){
      // open in new tab (if url)
      if(String(d.content).startsWith("http")){
        window.open(d.content, "_blank");
      }else{
        // base64 file: open
        window.open(d.content, "_blank");
      }
      showToast(`<b>Downloaded</b> file`, activeChatID);
    }
  }catch(e){
    showBanner("‚ùå Failed to download file");
  }
}

function setupAudio(uid, src){
  const wrap = document.getElementById(`aud-${uid}`);
  if(!wrap) return;
  wrap.innerHTML = `<audio src="${src}" controls style="height:32px; width:100%; filter:invert(.92);"></audio>`;
}

function showLightbox(src){
  document.getElementById('lb-img').src = src;
  document.getElementById('lightbox').style.display = 'flex';
}

/* ---------------- Info panel placeholder ---------------- */
function showInfo(){
  // ÿßÿ®⁄æ€å simple ‚Äî ÿ®ÿπÿØ ŸÖ€å⁄∫ profile/api ÿ≥€í details ŸÑ€í ŸÑ€å⁄∫ ⁄Ø€í
  showToast(`Info: <b>${escapeHTML(activeChatID || '')}</b>`, activeChatID);
}

/* ---------------- Background unread updates (simple) ----------------
   ÿßÿ®⁄æ€å backend ŸÖ€å⁄∫ global push ŸÜ€Å€å⁄∫ €Å€íÿå ÿ™Ÿà €ÅŸÖ lightweight polling ⁄©ÿ±ÿ™€í €Å€å⁄∫:
   - open chat ⁄©€åŸÑÿ¶€í already polling
   - chat list ⁄©€åŸÑÿ¶€í 10s ŸÖ€å⁄∫ refresh chats (ÿßŸàÿ± ÿß⁄Øÿ± cached messages ŸÖ€å⁄∫ new ÿ¢ÿ¶€í ÿ™Ÿà unread ÿ®⁄ë⁄æÿß ÿØ€å⁄∫)
*/
setInterval(async () => {
  if(!currentBot) return;
  if(activeChatID) return; // open chat already syncing
  // refresh chats silently
  await loadChatsFromServer();
}, 10000);

</script>

</body>
</html>